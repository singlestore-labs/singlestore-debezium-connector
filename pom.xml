<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.singlestore</groupId>
  <artifactId>singlestore-debezium-connector</artifactId>
  <version>0.1.5</version>
  <name>singlestore-debezium-connector</name>
  <description>SingleStore Debezium Connector</description>
  <url>https://github.com/singlestore-labs/singlestore-debezium-connector</url>

  <organization>
    <name>SingleStore</name>
    <url>https://www.singlestore.com/</url>
  </organization>

  <developers>
    <developer>
      <id>singlestore</id>
      <name>SingleStore</name>
      <email>team@singlestore.com</email>
      <organization>SingleStore</organization>
      <organizationUrl>https://www.singlestore.com/</organizationUrl>
    </developer>
  </developers>

  <scm>
    <url>git://git@github.com:singlestore-labs/singlestore-debezium-connector.git</url>
    <connection>scm:git:git@github.com:singlestore-labs/singlestore-debezium-connector.git
    </connection>
    <developerConnection>
      scm:git:git@github.com:singlestore-labs/singlestore-debezium-connector.git
    </developerConnection>
    <tag>singlestore-debezium-connector-0.1.5</tag>
  </scm>

  <licenses>
    <license>
      <name>Apache License, Version 2.0</name>
      <url>https://www.apache.org/licenses/LICENSE-2.0.txt</url>
      <distribution>repo</distribution>
    </license>
  </licenses>

  <properties>
    <maven.compiler.source>11</maven.compiler.source>
    <maven.compiler.target>11</maven.compiler.target>

    <version.debezium>2.5.1.Final</version.debezium>
    <version.kafka>3.6.1</version.kafka>
    <version.singlestore.jdbc.driver>1.2.0</version.singlestore.jdbc.driver>
    <version.jts.io>1.19.0</version.jts.io>

    <version.kafka-connect-avro-converter>7.5.1</version.kafka-connect-avro-converter>
    <version.connect-json>3.6.1</version.connect-json>
    <version.org.slf4j>2.0.4</version.org.slf4j>
    <version.logback-classic>1.4.14</version.logback-classic>
    <version.testcontainers>1.19.3</version.testcontainers>
    <version.awaitility>4.2.0</version.awaitility>
    <version.mockito>3.0.0</version.mockito>
    <version.junit>4.13.2</version.junit>
    <version.assertj-core>3.11.1</version.assertj-core>

    <version.assembly.plugin>3.6.0</version.assembly.plugin>
    <version.failsafe.plugin>3.2.3</version.failsafe.plugin>

    <!--
      Specify the properties that will be used for setting up the integration tests' Docker container.
      Note that the `dockerhost.ip` property is computed from the IP address of DOCKER_HOST, which will
      work on all platforms. We'll set some of these as system properties during integration testing.
    -->
    <singlestore.image>ghcr.io/singlestore-labs/singlestoredb-dev:latest</singlestore.image>
    <singlestore.version>dev:92a8a199-13fd-462d-a9ec-58ef94754473</singlestore.version>
    <singlestore.license>${env.SINGLESTORE_LICENSE}</singlestore.license>
    <singlestore.host>127.0.0.1</singlestore.host>
    <singlestore.port>3306</singlestore.port>
    <singlestore.user>root</singlestore.user>
    <singlestore.password>root</singlestore.password>
  </properties>

  <repositories>
    <repository>
      <id>confluent</id>
      <name>Confluent</name>
      <url>https://packages.confluent.io/maven/</url>
      <snapshots>
        <enabled>true</enabled>
        <updatePolicy>never</updatePolicy>
      </snapshots>
    </repository>
  </repositories>

  <dependencies>
    <dependency>
      <groupId>io.debezium</groupId>
      <artifactId>debezium-core</artifactId>
      <version>${version.debezium}</version>
    </dependency>
    <dependency>
      <groupId>org.apache.kafka</groupId>
      <artifactId>connect-api</artifactId>
      <version>${version.kafka}</version>
      <scope>provided</scope>
    </dependency>
    <dependency>
      <groupId>com.singlestore</groupId>
      <artifactId>singlestore-jdbc-client</artifactId>
      <version>${version.singlestore.jdbc.driver}</version>
    </dependency>
    <dependency>
      <groupId>org.locationtech.jts.io</groupId>
      <artifactId>jts-io-common</artifactId>
      <version>${version.jts.io}</version>
    </dependency>
    <!--logging-->
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-api</artifactId>
      <version>${version.org.slf4j}</version>
      <optional>true</optional>
    </dependency>
    <!-- Testing -->
    <dependency>
      <groupId>io.debezium</groupId>
      <artifactId>debezium-core</artifactId>
      <version>${version.debezium}</version>
      <type>test-jar</type>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.debezium</groupId>
      <artifactId>debezium-embedded</artifactId>
      <version>${version.debezium}</version>
      <type>test-jar</type>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.debezium</groupId>
      <artifactId>debezium-embedded</artifactId>
      <version>${version.debezium}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.confluent</groupId>
      <artifactId>kafka-connect-avro-converter</artifactId>
      <version>${version.kafka-connect-avro-converter}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.apache.kafka</groupId>
      <artifactId>connect-json</artifactId>
      <version>${version.connect-json}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>ch.qos.logback</groupId>
      <artifactId>logback-classic</artifactId>
      <scope>test</scope>
      <version>${version.logback-classic}</version>
    </dependency>
    <dependency>
      <groupId>org.testcontainers</groupId>
      <artifactId>testcontainers</artifactId>
      <version>${version.testcontainers}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.awaitility</groupId>
      <artifactId>awaitility</artifactId>
      <version>${version.awaitility}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.mockito</groupId>
      <artifactId>mockito-core</artifactId>
      <version>${version.mockito}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <scope>test</scope>
      <version>${version.junit}</version>
    </dependency>
    <dependency>
      <groupId>org.assertj</groupId>
      <artifactId>assertj-core</artifactId>
      <scope>test</scope>
      <version>${version.assertj-core}</version>
    </dependency>
  </dependencies>

  <distributionManagement>
    <snapshotRepository>
      <id>ossrh</id>
      <url>https://oss.sonatype.org/content/repositories/snapshots</url>
    </snapshotRepository>
    <repository>
      <id>ossrh</id>
      <url>https://oss.sonatype.org/service/local/staging/deploy/maven2/</url>
    </repository>
  </distributionManagement>

  <build>
    <plugins>
      <plugin>
        <groupId>io.fabric8</groupId>
        <artifactId>docker-maven-plugin</artifactId>
        <configuration>
          <watchInterval>500</watchInterval>
          <logDate>default</logDate>
          <verbose>true</verbose>
          <images>
            <image>
              <!-- A Docker image with SingleStoreDB cluster -->
              <name>${singlestore.image}</name>
              <run>
                <namingStrategy>none</namingStrategy>
                <ports>
                  <port>${singlestore.port}:3306</port>
                </ports>
                <env>
                  <SINGLESTORE_LICENSE>${singlestore.license}</SINGLESTORE_LICENSE>
                  <ROOT_PASSWORD>${singlestore.password}</ROOT_PASSWORD>
                  <SINGLESTORE_VERSION>${singlestore.version}</SINGLESTORE_VERSION>
                </env>
                <!-- Uncomment this to see database logs in the test output
                <log>
                    <prefix>SingleStoreDB &gt;&gt;&gt; </prefix>
                    <enabled>true</enabled>
                    <color>yellow</color>
                </log>
                -->
                <wait>
                  <time>300000</time> <!-- 300 seconds max -->
                  <log>Log Opened</log>
                </wait>
              </run>
            </image>
          </images>
        </configuration>
        <!--
        Connect this plugin to the maven lifecycle around the integration-test phase:
        start the container in pre-integration-test and stop it in post-integration-test.
        -->
        <executions>
          <execution>
            <id>start</id>
            <phase>pre-integration-test</phase>
            <goals>
              <goal>build</goal>
              <goal>start</goal>
            </goals>
          </execution>
          <execution>
            <id>stop</id>
            <phase>post-integration-test</phase>
            <goals>
              <goal>stop</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <!--
      Unlike surefire, the failsafe plugin ensures 'post-integration-test' phase always runs, even
      when there are failed integration tests. We rely upon this to always shut down the Docker container
      after the integration tests (defined as '*IT.java') are run.
      -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-failsafe-plugin</artifactId>
        <executions>
          <execution>
            <id>integration-test</id>
            <goals>
              <goal>integration-test</goal>
            </goals>
          </execution>
          <execution>
            <id>verify</id>
            <goals>
              <goal>verify</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <includes>
            <include>**/*</include>
          </includes>
          <enableAssertions>true</enableAssertions>
          <systemPropertyVariables>
            <!-- Make these available to the tests via system properties -->
            <singlestore.hostname>${singlestore.host}</singlestore.hostname>
            <singlestore.port>${singlestore.port}</singlestore.port>
            <singlestore.user>${singlestore.user}</singlestore.user>
            <singlestore.password>${singlestore.password}</singlestore.password>
            <singlestore.version>${singlestore.version}</singlestore.version>
          </systemPropertyVariables>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-gpg-plugin</artifactId>
        <version>3.0.1</version>
        <executions>
          <execution>
            <phase>verify</phase>
            <goals>
              <goal>sign</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.sonatype.plugins</groupId>
        <artifactId>nexus-staging-maven-plugin</artifactId>
        <version>1.6.13</version>
        <extensions>true</extensions>
        <executions>
          <execution>
            <phase>deploy</phase>
          </execution>
        </executions>
        <configuration>
          <serverId>ossrh</serverId>
          <nexusUrl>https://oss.sonatype.org/</nexusUrl>
          <autoReleaseAfterClose>true</autoReleaseAfterClose>
          <stagingProgressTimeoutMinutes>15</stagingProgressTimeoutMinutes>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-javadoc-plugin</artifactId>
        <version>2.9.1</version>
        <configuration>
          <additionalparam>-Xdoclint:none</additionalparam>
        </configuration>
        <executions>
          <execution>
            <id>attach-javadocs</id>
            <goals>
              <goal>jar</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-source-plugin</artifactId>
        <version>3.2.1</version>
        <executions>
          <execution>
            <!--package phase-->
            <goals>
              <goal>jar</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
    <resources>
      <!-- Apply the properties set in the POM to the resource files -->
      <resource>
        <filtering>true</filtering>
        <directory>src/main/resources</directory>
        <includes>
          <include>*</include>
          <include>**/*</include>
        </includes>
      </resource>
    </resources>
  </build>

  <profiles>
    <profile>
      <id>assembly</id>
      <activation>
        <activeByDefault>false</activeByDefault>
      </activation>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-assembly-plugin</artifactId>
            <version>${version.assembly.plugin}</version>
            <dependencies>
              <dependency>
                <groupId>io.debezium</groupId>
                <artifactId>debezium-assembly-descriptors</artifactId>
                <version>${version.debezium}</version>
              </dependency>
            </dependencies>
            <executions>
              <execution>
                <id>default</id>
                <phase>package</phase>
                <goals>
                  <goal>single</goal>
                </goals>
                <configuration>
                  <finalName>${project.artifactId}-${project.version}</finalName>
                  <attach>true</attach>  <!-- we want attach & deploy these to Maven -->
                  <descriptorRefs>
                    <descriptorRef>connector-distribution</descriptorRef>
                  </descriptorRefs>
                  <tarLongFileMode>posix</tarLongFileMode>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
  </profiles>
</project>
